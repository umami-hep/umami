# Tag of TensorFlow base image
# https://pypi.org/project/tensorflow/#history
variables:
  TFTAG: 2.5.0
  TORCHTAG: 1.9.0-cuda11.1-cudnn8-runtime

stages:
  - linting
  - image_build_umamibase
  - unit_test
  - integration_test_preprocessing
  - integration_test_tagger
  - integration_test_plotting
  - coverage_test_stage
  - builds
  - image_build_umami
  - publish

linter:
  stage: linting
  image: python:3.7-slim
  script:
    - mkdir coverage_files/
    - pip install flake8
    - flake8 ./umami
  artifacts:
    when: always
    paths:
      - coverage_files/
  rules:
    - if: $CI_COMMIT_BRANCH != ''
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

test_coverage:
  stage: coverage_test_stage
  image: python:3.7-slim
  script:
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt
    - cd ./coverage_files/
    - coverage combine
    - coverage report
    - coverage xml
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_PATH=="atlas-flavor-tagging-tools/algorithms/umami"  
  artifacts:
    when: always
    paths:
      - coverage_files/
    reports:
      cobertura: coverage_files/coverage.xml
  retry: 2

include:
  - 'pipelines/.unit_test-gitlab-ci.yaml'
  - 'pipelines/.docker-gitlab-ci.yaml'
  - 'pipelines/.docs-gitlab-ci.yaml'
  - 'pipelines/.integration_test-gitlab-ci.yaml'
